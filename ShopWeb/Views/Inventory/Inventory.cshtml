@using ShopWeb.Application.TransferObjects.Products
@model ShopWeb.Application.TransferObjects.Inventory.CommonInventoryPositionVm
@{
    ViewData["Title"] = "Dodaj pozycje inwentaryzacyjne";
    var inventory = ViewBag.Inventory as ShopWeb.Application.TransferObjects.Inventory.InventoryVm;
    var positions = ViewBag.Positions as List<ShopWeb.Application.TransferObjects.Inventory.CommonInventoryPositionVm> ?? new List<ShopWeb.Application.TransferObjects.Inventory.CommonInventoryPositionVm>();
    var units = ViewBag.Units as List<ProductUnitVm> ?? new List<ProductUnitVm>();
    var defaultUnit = units.FirstOrDefault(u => u.Code == "szt") ?? units.FirstOrDefault();
}

<h2>@ViewData["Title"]</h2>
<h4>Inwentaryzacja: @inventory?.Name</h4>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Dodaj nową pozycję</h5>
            </div>
            <div class="card-body">
                <form id="addPositionForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="InventoryId" />

                    <div class="mb-3">
                        <label asp-for="ProductName" class="form-label">Nazwa produktu</label>
                        <input asp-for="ProductName" id="productNameInput" class="form-control" required />
                        <span asp-validation-for="ProductName" class="text-danger"></span>
                    </div>

                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <label asp-for="Quantity" class="form-label">Ilość</label>
                            <input asp-for="Quantity" type="number" step="0.01" class="form-control" value="1.0" required />
                            <span asp-validation-for="Quantity" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="UnitId" class="form-label">Jednostka</label>
                            <select asp-for="UnitId" class="form-select" required>
                                <option value="">Wybierz jednostkę</option>
                                @foreach (var unit in units)
                                {
                                    <option value="@unit.Id"
                                            data-unit-name="@unit.Code"
                                            selected="@(unit.Code == "szt")">
                                        @unit.Name
                                    </option>
                                }
                            </select>
                            <span asp-validation-for="UnitId" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="Price" class="form-label">Cena</label>
                            <input asp-for="Price" type="number" step="0.01" class="form-control" required />
                            <span asp-validation-for="Price" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-plus-circle"></i> Dodaj pozycję
                            </button>
                        </div>
                    </div>
                </form>

                <div id="alertContainer" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Dodane pozycje (@positions.Count)</h5>
                @if (positions.Any())
                {
                    <button type="button" class="btn btn-sm btn-danger" onclick="clearPositions()">
                        Wyczyść listę
                    </button>
                }
            </div>
            <div class="card-body">
                <div id="positionsList">
                    @if (positions.Any())
                    {
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Produkt</th>
                                    <th>Ilość</th>
                                    <th>J.M.</th>
                                    <th>Cena</th>
                                    <th>Data</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody id="positionsTableBody">
                                @foreach (var position in positions)
                                {
                                    <tr data-position-id="@position.Id"
                                        data-product-name="@position.ProductName"
                                        data-quantity="@position.Quantity"
                                        data-price="@position.Price"
                                        data-unit-id="@position.UnitId">
                                        <td>@position.ProductName</td>
                                        <td>@position.Quantity</td>
                                        <td>@position.Unit</td>
                                        <td>@position.Price.ToString("C")</td>
                                        <td>@position.ScanDate.ToString("dd.MM.yyyy HH:mm:ss")</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-warning me-1" 
                                                    onclick="editPositionFromRow(this)"
                                                    title="Edytuj">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" 
                                                    onclick="deletePosition(@position.Id)"
                                                    title="Usuń">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted text-center" id="emptyMessage">Brak dodanych pozycji</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <a asp-action="Index" class="btn btn-secondary">Powrót do listy</a>
    @if (positions.Any())
    {
        <a asp-action="InventorySummary" asp-route-inventoryId="@inventory?.Id" class="btn btn-success">
            Przejdź do podsumowania
        </a>
    }
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        const inventoryId = @Model.InventoryId;
        let editingPositionId = null;

        document.getElementById('addPositionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const unitSelect = document.querySelector('[name="UnitId"]');
            const selectedOption = unitSelect.options[unitSelect.selectedIndex];
            const unitCode = selectedOption.getAttribute('data-unit-code') || '';
            const unitName = selectedOption.getAttribute('data-unit-name') || '';

            const formData = {
                id: editingPositionId || 0,
                inventoryId: inventoryId,
                productName: document.querySelector('[name="ProductName"]').value,
                quantity: parseFloat(document.querySelector('[name="Quantity"]').value),
                price: parseFloat(document.querySelector('[name="Price"]').value),
                unitId: parseInt(document.querySelector('[name="UnitId"]').value),
                unit: unitName
            };

            const isEditing = editingPositionId !== null;
            const url = isEditing 
                ? '@Url.Action("EditInventoryPosition", "Inventory")'
                : '@Url.Action("AddInventoryPosition", "Inventory")';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', result.message);
                    
                    if (isEditing) {
                        updatePositionInList(result.position);
                        cancelEdit();
                    } else {
                        addPositionToList(result.position);
                    }
                    
                    this.reset();
                    document.querySelector('[name="InventoryId"]').value = inventoryId;
                    setFocusOnProductName();
                } else {
                    showAlert('danger', result.message);
                }
            } catch (error) {
                showAlert('danger', 'Wystąpił błąd podczas ' + (isEditing ? 'edycji' : 'dodawania') + ' pozycji');
                console.error(error);
            }
        });

        function addPositionToList(position) {
            const emptyMessage = document.getElementById('emptyMessage');
            if (emptyMessage) {
                emptyMessage.remove();
                document.getElementById('positionsList').innerHTML = `
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Produkt</th>
                                <th>Ilość</th>
                                <th>J.M.</th>
                                <th>Cena</th>
                                <th>Data</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody id="positionsTableBody"></tbody>
                    </table>
                `;
            }

            const tableBody = document.getElementById('positionsTableBody');
            const row = tableBody.insertRow(0);
            row.setAttribute('data-position-id', position.id);
            row.setAttribute('data-product-name', position.productName);
            row.setAttribute('data-quantity', position.quantity);
            row.setAttribute('data-price', position.price);
            row.setAttribute('data-unit-id', position.unitId);
            
            const scanDate = new Date(position.scanDate);
            const formattedDate = scanDate.toLocaleString('pl-PL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(',', '');

            const productNameEscaped = escapeHtml(position.productName);
            
            row.innerHTML = `
                <td>${productNameEscaped}</td>
                <td>${position.quantity}</td>
                <td>${position.unit}</td>
                <td>${new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' }).format(position.price)}</td>
                <td>${formattedDate}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-warning me-1" 
                            onclick="editPositionFromRow(this)"
                            title="Edytuj">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" 
                            onclick="deletePosition(${position.id})"
                            title="Usuń">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
        }

        function updatePositionInList(position) {
            const row = document.querySelector(`tr[data-position-id="${position.id}"]`);
            if (!row) return;

            row.setAttribute('data-product-name', position.productName);
            row.setAttribute('data-quantity', position.quantity);
            row.setAttribute('data-price', position.price);
            row.setAttribute('data-unit-id', position.unitId);

            const scanDate = new Date(position.scanDate);
            const formattedDate = scanDate.toLocaleString('pl-PL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).replace(',', '');

            const productNameEscaped = escapeHtml(position.productName);

            row.innerHTML = `
                <td>${productNameEscaped}</td>
                <td>${position.quantity}</td>
                <td>${position.unit}</td>
                <td>${new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' }).format(position.price)}</td>
                <td>${formattedDate}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-warning me-1" 
                            onclick="editPositionFromRow(this)"
                            title="Edytuj">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" 
                            onclick="deletePosition(${position.id})"
                            title="Usuń">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
        }

        function editPositionFromRow(button) {
            const row = button.closest('tr');
            const id = parseInt(row.getAttribute('data-position-id'));
            const productName = row.getAttribute('data-product-name');
            const quantity = parseFloat(row.getAttribute('data-quantity'));
            const price = parseFloat(row.getAttribute('data-price'));
            const unitId = parseInt(row.getAttribute('data-unit-id'));
            
            editPosition(id, productName, quantity, price, unitId);
        }

        function editPosition(id, productName, quantity, price, unitId) {
            editingPositionId = id;
            
            document.querySelector('[name="ProductName"]').value = productName;
            document.querySelector('[name="Quantity"]').value = quantity;
            document.querySelector('[name="Price"]').value = price;
            document.querySelector('[name="UnitId"]').value = unitId;
            
            const submitButton = document.querySelector('#addPositionForm button[type="submit"]');
            submitButton.innerHTML = '<i class="bi bi-check-circle"></i> Zapisz zmiany';
            submitButton.classList.remove('btn-primary');
            submitButton.classList.add('btn-success');
            
            const cancelButton = document.createElement('button');
            cancelButton.type = 'button';
            cancelButton.className = 'btn btn-secondary w-100 mt-2';
            cancelButton.innerHTML = '<i class="bi bi-x-circle"></i> Anuluj';
            cancelButton.onclick = cancelEdit;
            cancelButton.id = 'cancelEditButton';
            
            if (!document.getElementById('cancelEditButton')) {
                submitButton.parentElement.appendChild(cancelButton);
            }
            
            setFocusOnProductName();
        }

        function cancelEdit() {
            editingPositionId = null;
            
            document.getElementById('addPositionForm').reset();
            document.querySelector('[name="InventoryId"]').value = inventoryId;
            
            const submitButton = document.querySelector('#addPositionForm button[type="submit"]');
            submitButton.innerHTML = '<i class="bi bi-plus-circle"></i> Dodaj pozycję';
            submitButton.classList.remove('btn-success');
            submitButton.classList.add('btn-primary');
            
            const cancelButton = document.getElementById('cancelEditButton');
            if (cancelButton) {
                cancelButton.remove();
            }
            
            setFocusOnProductName();
        }

        async function deletePosition(id) {
            if (!confirm('Czy na pewno chcesz usunąć tę pozycję?')) return;

            try {
                const response = await fetch('@Url.Action("DeleteInventoryPosition", "Inventory")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ 
                        id: id,
                        inventoryId: inventoryId 
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'Pozycja została usunięta pomyślnie');
                    
                    const row = document.querySelector(`tr[data-position-id="${id}"]`);
                    if (row) {
                        row.remove();
                        
                        const tableBody = document.getElementById('positionsTableBody');
                        if (tableBody && tableBody.children.length === 0) {
                            document.getElementById('positionsList').innerHTML = 
                                '<p class="text-muted text-center" id="emptyMessage">Brak dodanych pozycji</p>';
                        }
                    }
                } else {
                    showAlert('danger', result.message);
                }
            } catch (error) {
                showAlert('danger', 'Wystąpił błąd podczas usuwania pozycji');
                console.error(error);
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
        }

        async function clearPositions() {
            if (!confirm('Czy na pewno chcesz wyczyścić wszystkie pozycje?')) return;

            try {
                const response = await fetch('@Url.Action("ClearInventoryPositions", "Inventory")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ inventoryId: inventoryId })
                });

                if (response.ok) {
                    location.reload();
                }
            } catch (error) {
                console.error(error);
            }
        }

        function setFocusOnProductName() {
            const productNameInput = document.getElementById('productNameInput');
            if (productNameInput) {
                productNameInput.focus();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setFocusOnProductName();
        });
    </script>
}