@model ShopWeb.Application.TransferObjects.Inventory.NewInventoryVm

@{
    ViewData["Title"] = "Tworzenie nowej inwentaryzacji";
}


<h1>@ViewData["Title"]</h1>
<div class="row">
    <div class="col-md-8">
        <form asp-action="CreateInventory" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Podstawowe informacje</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label asp-for="Name" class="control-label"></label>
                        <input asp-for="Name" class="form-control" />
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Type" class="control-label"></label>
                        <input asp-for="Type" class="form-control" />
                        <span asp-validation-for="Type" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="ExecuteWay" class="control-label"></label>
                        <input asp-for="ExecuteWay" class="form-control" />
                        <span asp-validation-for="ExecuteWay" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="ResponsiblePerson" class="control-label"></label>
                        <input asp-for="ResponsiblePerson" class="form-control" />
                        <span asp-validation-for="ResponsiblePerson" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5>Informacje o firmie</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label asp-for="CompanyName" class="control-label"></label>
                        <input asp-for="CompanyName" class="form-control" />
                        <span asp-validation-for="CompanyName" class="text-danger"></span>
                    </div>
                    <div class="form-group mb-3">
                        <label asp-for="CompanyAddress" class="control-label"></label>
                        <input asp-for="CompanyAddress" class="form-control" />
                        <span asp-validation-for="CompanyAddress" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <h5>Skład komisji inwentaryzacyjnej</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label class="control-label">Dodaj członka komisji</label>
                        <div class="input-group mb-2">
                            <input type="text" id="newTeamMember" class="form-control" placeholder="Imię i nazwisko członka komisji" />
                            <button type="button" class="btn btn-primary" id="addTeamMemberBtn">
                                <i class="bi bi-plus-circle"></i> Dodaj
                            </button>
                        </div>
                    </div>

                    <!-- Container for displaying added team members -->
                    <div id="commissionTeamList" class="mb-3">
                        @if (Model?.ComissionTeam != null && Model.ComissionTeam.Any())
                        {
                            @for (int i = 0; i < Model.ComissionTeam.Count; i++)
                            {
                                <div class="input-group mb-2 team-member-item">
                                    <input type="text" name="CommissionTeam[@i]" value="@Model.ComissionTeam[i]" class="form-control" readonly />
                                    <button type="button" class="btn btn-danger btn-remove-member">
                                        <i class="bi bi-trash"></i> Usuń
                                    </button>
                                </div>
                            }
                        }
                    </div>

                    <!-- Display current team members as a list -->
                    <div id="teamMembersList">
                        <h6>Aktualni członkowie komisji:</h6>
                        <ul id="teamMembersDisplay" class="list-group">
                            @if (Model?.ComissionTeam != null && Model.ComissionTeam.Any())
                            {
                                @foreach (var member in Model.ComissionTeam)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        @member
                                    </li>
                                }
                            }
                            else
                            {
                                <li class="list-group-item text-muted" id="noMembersMessage">Brak członków komisji</li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Osoby sprawdzające</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label asp-for="PersonToValue" class="control-label"></label>
                        <input asp-for="PersonToValue" class="form-control" />
                        <span asp-validation-for="PersonToValue" class="text-danger"></span>
                    </div>
                    <div class="form-group mb-3">
                        <label asp-for="PersonToCheck" class="control-label"></label>
                        <input asp-for="PersonToCheck" class="form-control" />
                        <span asp-validation-for="PersonToCheck" class="text-danger"></span>
                    </div>
                </div>
            </div>
            <div class="form-group mb-3">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-save"></i> Zapisz inwentaryzację
                </button>
                <a asp-action="Index" class="btn btn-secondary btn-lg">
                    <i class="bi bi-arrow-left"></i> Powrót do listy
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {
            let memberIndex = @(Model?.ComissionTeam?.Count ?? 0);

            // Add team member
            $('#addTeamMemberBtn').click(function () {
                const memberName = $('#newTeamMember').val().trim();

                if (memberName === '') {
                    alert('Proszę wpisać imię i nazwisko członka komisji');
                    return;
                }

                // Remove "no members" message if it exists
                $('#noMembersMessage').remove();

                // Add hidden input for model binding
                const inputGroup = `
                    <div class="input-group mb-2 team-member-item">
                        <input type="text" name="ComissionTeam[${memberIndex}]" value="${memberName}" class="form-control" readonly />
                        <button type="button" class="btn btn-danger btn-remove-member">
                            <i class="bi bi-trash"></i> Usuń
                        </button>
                    </div>`;

                $('#commissionTeamList').append(inputGroup);

                // Add to display list
                const listItem = `
                    <li class="list-group-item d-flex justify-content-between align-items-center" data-index="${memberIndex}">
                        ${memberName}
                    </li>`;

                $('#teamMembersDisplay').append(listItem);

                // Clear input and increment index
                $('#newTeamMember').val('');
                memberIndex++;
            });

            // Remove team member (using event delegation)
            $(document).on('click', '.btn-remove-member', function () {
                const container = $(this).closest('.team-member-item');
                const input = container.find('input');
                const inputName = input.attr('name');
                const indexMatch = inputName.match(/\[(\d+)\]/);

                if (indexMatch) {
                    const index = indexMatch[1];

                    // Remove from hidden inputs
                    container.remove();

                    // Remove from display list
                    $(`#teamMembersDisplay li[data-index="${index}"]`).remove();

                    // Reindex remaining inputs
                    reindexTeamMembers();

                    // Show "no members" message if list is empty
                    if ($('#commissionTeamList .team-member-item').length === 0) {
                        $('#teamMembersDisplay').html('<li class="list-group-item text-muted" id="noMembersMessage">Brak członków komisji</li>');
                        memberIndex = 0;
                    }
                }
            });

            // Reindex team members after removal
            function reindexTeamMembers() {
                $('#commissionTeamList .team-member-item').each(function (index) {
                    $(this).find('input').attr('name', `ComissionTeam[${index}]`);
                });

                $('#teamMembersDisplay li').each(function (index) {
                    $(this).attr('data-index', index);
                });

                memberIndex = $('#commissionTeamList .team-member-item').length;
            }

            // Allow adding member with Enter key
            $('#newTeamMember').keypress(function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $('#addTeamMemberBtn').click();
                }
            });
        });
    </script>
}